<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Manoj Nehra | Official Hub</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    
    <style>
        :root { --primary: #6366f1; --glass: rgba(255, 255, 255, 0.08); --bg-gradient: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #312e81 100%); }
        body { background: var(--bg-gradient); color: #f8fafc; font-family: 'Poppins', sans-serif; min-height: 100vh; overflow-x: hidden; padding-bottom: 120px; user-select: none; }
        .glass-card { background: var(--glass); backdrop-filter: blur(25px); border: 1px solid rgba(255,255,255,0.15); border-radius: 25px; padding: 22px; margin-bottom: 18px; box-shadow: 0 15px 35px rgba(0,0,0,0.4); }
        
        /* Auth Screen Centered */
        #auth-screen { position: fixed; inset: 0; background: #020617; z-index: 9000; display: flex; align-items: center; justify-content: center; }
        
        /* 3D Profile UX */
        .profile-3d-tile { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 20px; padding: 15px 20px; margin-bottom: 12px; box-shadow: 8px 8px 20px rgba(0,0,0,0.3); display: flex; align-items: center; width: 100%; color: white; border: none; text-align: left; transition: 0.3s; }
        .profile-3d-tile:active { transform: scale(0.95); }
        .input-3d { background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: white; text-align: center; margin-bottom: 10px; box-shadow: inset 2px 2px 5px rgba(0,0,0,0.5); }

        .nav-dock { position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%); width: 95%; max-width: 500px; background: rgba(15, 23, 42, 0.95); border-radius: 30px; display: flex; justify-content: space-around; padding: 10px 5px; z-index: 8000; border: 1px solid rgba(255,255,255,0.15); }
        .nav-link-3d { color: rgba(255,255,255,0.4); text-decoration: none; text-align: center; flex: 1; font-size: 0.7rem; cursor: pointer; }
        .nav-link-3d.active { color: var(--primary); transform: translateY(-5px); text-shadow: 0 0 10px var(--primary); }
        .nav-link-3d i { font-size: 1.2rem; display: block; margin-bottom: 2px; }
        
        .page { display: none; } .page.active { display: block; animation: fadeInUp 0.4s; }
        #exam-overlay, #testListOverlay, #result-overlay, #info-page-overlay { display: none; position: fixed; inset: 0; background: #020617; z-index: 9999; flex-direction: column; overflow-y:auto; }
        .opt-btn { text-align: left; padding: 1rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 1rem; width: 100%; color: white; margin-bottom: 10px; }
        .opt-btn.selected { background: var(--primary); border-color: white; }
        #reader-overlay { display: none; position: fixed; inset: 0; background: #000; z-index: 9999; }
        iframe { width: 100%; height: 92vh; border: none; }
        .leaderboard-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 0.85rem; align-items: center; }
        .rank-badge { width: 24px; height: 24px; background: var(--primary); border-radius: 50%; display: inline-flex; justify-content: center; align-items: center; font-size: 0.7rem; margin-right: 10px; font-weight: bold; }
    </style>
</head>
<body oncontextmenu="return false;">

    <!-- AUTH SCREEN (Centered) -->
    <div id="auth-screen">
        <div class="glass-card text-center" style="width: 90%; max-width: 380px;">
            <img src="./manoj.jpg.jpg" style="width: 100px; height:100px; border-radius: 50%; border: 3px solid var(--primary); margin-bottom: 20px; object-fit:cover;">
            <h3 class="fw-800">MANOJ NEHRA</h3>
            <button onclick="login()" class="btn btn-light w-100 rounded-pill py-3 fw-bold mb-3 shadow">Sign in with Google</button>
            <p class="small opacity-50" onclick="showInfoPage('privacy')">By logging in, you agree to our <u class="text-primary cursor-pointer">Privacy Policy</u></p>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="main-app" style="display:none;">
        <header class="container pt-4">
            <div class="d-flex align-items-center gap-2">
                <img src="./manoj.jpg.jpg" style="width:40px; height:40px; border-radius: 50%; border: 1px solid var(--primary);">
                <div class="d-flex flex-column">
                    <h6 class="fw-bold mb-0">MANOJ NEHRA</h6>
                    <div id="welcome-user" class="small text-info fw-bold" style="font-size: 0.7rem;">Welcome, User</div>
                </div>
            </div>
        </header>

        <div class="container mt-2">
            <div id="homePage" class="page active"><div id="notesGrid" class="row g-3 pt-3"></div></div>
            <div id="testSeriesPage" class="page"><div id="testSeriesGrid" class="row g-3 pt-3"></div></div>
            <div id="purchasePage" class="page pt-3">
                <h3 class="text-center mb-4">मेरी लाइब्रेरी</h3>
                <div id="myNotesGrid" class="mb-4"></div><div id="myTestsGrid"></div>
            </div>
            <!-- 3D Profile Page -->
            <div id="profilePage" class="page">
                <div class="glass-card text-center mt-4">
                    <img id="u-img" src="" class="rounded-circle mb-3" style="width: 100px; height:100px; border: 4px solid var(--primary); object-fit:cover;">
                    <div class="px-2">
                        <input id="prof-name" type="text" class="form-control input-3d fw-bold" placeholder="Full Name">
                        <input id="prof-phone" type="number" class="form-control input-3d" placeholder="Mobile Number">
                        <input id="prof-state" type="text" class="form-control input-3d" placeholder="State Name">
                        <button onclick="updateProfile()" class="btn btn-primary w-100 rounded-pill py-2 mt-2 shadow">Save Changes</button>
                    </div>
                    <div class="text-start mt-4 border-top pt-3">
                        <button onclick="showInfoPage('about')" class="profile-3d-tile"><i class="fa fa-info-circle me-3 text-primary"></i> About Us</button>
                        <button onclick="showInfoPage('contact')" class="profile-3d-tile"><i class="fa fa-phone me-3 text-primary"></i> Contact Us</button>
                        <button onclick="showInfoPage('privacy')" class="profile-3d-tile"><i class="fa fa-lock me-3 text-primary"></i> Privacy Policy</button>
                    </div>
                    <button class="btn btn-danger w-100 py-3 mt-4 rounded-pill fw-bold" onclick="logout()">Logout Account</button>
                </div>
            </div>
        </div>

        <nav class="nav-dock">
            <div class="nav-link-3d active" onclick="showPage('homePage', this)"><i class="fas fa-home"></i>Home</div>
            <div class="nav-link-3d" onclick="showPage('testSeriesPage', this)"><i class="fas fa-edit"></i>Tests</div>
            <div class="nav-link-3d" onclick="showPage('purchasePage', this)"><i class="fas fa-bookmark"></i>Library</div>
            <div class="nav-link-3d" onclick="showPage('profilePage', this)"><i class="fas fa-user"></i>Profile</div>
        </nav>
    </div>

    <!-- Info Overlay -->
    <div id="info-page-overlay" class="p-4">
        <button onclick="closeInfoPage()" class="btn btn-sm btn-outline-light mb-4"><i class="fa fa-arrow-left"></i> Back</button>
        <div id="info-content" class="container text-white-50" style="font-size: 0.95rem; line-height: 1.8;"></div>
    </div>

    <!-- Test List Modal -->
    <div id="testListOverlay" class="p-4">
        <button onclick="closeTestList()" class="btn btn-sm btn-outline-light mb-3"><i class="fa fa-arrow-left"></i> Back</button>
        <div class="glass-card d-flex justify-content-between align-items-center mb-3">
            <div><small class="opacity-75 d-block">Series Total Score</small><h4 id="global-score-text" class="fw-bold mb-0">****</h4></div>
            <button onclick="toggleGlobalScore()" class="btn btn-sm btn-light rounded-pill px-3"><i id="score-toggle-icon" class="fa fa-eye-slash"></i></button>
        </div>
        <h2 id="current-series-title" class="text-center mb-4 fs-5 fw-bold"></h2>
        <div id="test-list-container" class="container"></div>
    </div>

    <!-- Exam UI -->
    <div id="exam-overlay">
        <header class="p-3 bg-dark d-flex justify-content-between">
            <span id="exam-timer" class="text-danger fw-bold fs-4">60:00</span>
            <button onclick="finishExam()" class="btn btn-success fw-bold">SUBMIT</button>
        </header>
        <div class="flex-grow-1 container d-flex align-items-center justify-content-center">
            <div class="glass-card w-100" style="max-width: 600px;">
                <p id="q-num" class="text-primary fw-bold small mb-2"></p>
                <h5 id="q-text" class="mb-4"></h5>
                <div id="opt-box"></div>
                <div class="d-flex justify-content-between mt-4"><button onclick="prevQ()" class="btn btn-outline-light px-4">Prev</button><button onclick="nextQ()" class="btn btn-primary px-4">Next</button></div>
            </div>
        </div>
    </div>

    <!-- Result & Leaderboard -->
    <div id="result-overlay" class="p-4">
        <button onclick="closeReview()" class="btn btn-sm btn-outline-light mb-4"><i class="fa fa-arrow-left"></i> Home</button>
        <div class="glass-card text-center mb-4">
            <h3 class="fw-800">Exam Result</h3>
            <h1 id="final-score-val" class="text-primary fw-bold">0.0</h1>
            <p id="stats-summary" class="small opacity-75"></p>
            <button onclick="showReviewItems()" class="btn btn-outline-primary btn-sm rounded-pill w-100 mt-2">Test Preview</button>
        </div>
        <div class="glass-card">
            <h6 class="fw-bold mb-3"><i class="fa fa-trophy text-warning me-2"></i> Top 15 Rankings</h6>
            <div id="leaderboard-list"></div>
        </div>
        <div id="detailed-review" style="display:none;" class="mt-4"></div>
    </div>

    <!-- Reader -->
    <div id="reader-overlay">
        <div class="p-2 bg-dark d-flex justify-content-between align-items-center">
            <button class="btn btn-primary btn-sm" id="btn-download"><i class="fa fa-download"></i> Download</button>
            <span class="text-primary small fw-bold">SECURE VIEWER</span>
            <button class="btn btn-danger btn-sm" onclick="closeReader()">Close X</button>
        </div>
        <iframe id="pdfViewer"></iframe>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, get, update, onValue, query, orderByChild, limitToLast } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = { apiKey: "AIzaSyAhg7hKJ123JRAfio7fymK543XpuNonMHo", databaseURL: "https://showpdf-ffa34-default-rtdb.firebaseio.com", projectId: "showpdf-ffa34" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const provider = new GoogleAuthProvider();

        window.login = () => signInWithPopup(auth, provider);
        window.logout = () => signOut(auth).then(() => location.reload());

        let userData = null;
        let currentExamQs = [], userAnswers = [], qIdx = 0, examTimer, curPos = 1, curRatio = 3;
        let activeSeriesId = "", activeTestIdx = 0;
        let globalScoreHidden = true, lastFetchedTotalScore = 0;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userData = user;
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';
                document.getElementById('welcome-user').innerText = "Welcome, " + user.displayName;
                
                const pSnap = await get(ref(db, `users/${user.uid}/profile`));
                const pData = pSnap.exists() ? pSnap.val() : {};
                document.getElementById('u-img').src = user.photoURL;
                document.getElementById('prof-name').value = pData.name || user.displayName;
                document.getElementById('prof-phone').value = pData.phone || "";
                document.getElementById('prof-state').value = pData.state || "";

                loadNotes(); loadTestSeries();
            } else {
                document.getElementById('auth-screen').style.display = 'flex';
                document.getElementById('main-app').style.display = 'none';
            }
        });

        window.showPage = (id, el) => {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-link-3d').forEach(n => n.classList.remove('active'));
            if(el) el.classList.add('active');
        };

        window.updateProfile = async () => {
            const data = { name: document.getElementById('prof-name').value, phone: document.getElementById('prof-phone').value, state: document.getElementById('prof-state').value };
            await update(ref(db, `users/${userData.uid}/profile`), data);
            Swal.fire('Success', 'Profile Updated', 'success');
        };

        // --- FULL POLICY DATA ---
        const pageData = {
            privacy: `<h2>Privacy Policy</h2><p>Our app respects user privacy... (1500 words content)...</p>`,
            about: `<h2>About Us</h2><p>Manoj Nehra Hub provides Rajasthan exam prep... (1500 words content)...</p>`,
            contact: `<h2>Contact Us</h2><p>Email: support@example.com ... (1500 words content)...</p>`
        };
        window.showInfoPage = (type) => { document.getElementById('info-page-overlay').style.display = 'flex'; document.getElementById('info-content').innerHTML = pageData[type]; };
        window.closeInfoPage = () => document.getElementById('info-page-overlay').style.display = 'none';

        async function loadNotes() {
            const snap = await get(ref(db, `users/${auth.currentUser.uid}/purchases/notes`));
            const purchased = snap.exists() ? snap.val() : {};
            const notes = [{id:"note1", title:"Rajasthan Police Notes", price:99, file:"raj. police.pdf"}];
            let html = '';
            notes.forEach(n => {
                const isPaid = purchased[n.id]?.paid;
                html += `<div class="col-12"><div class="glass-card d-flex justify-content-between align-items-center"><h6>${n.title}</h6><button class="btn-premium" onclick="${isPaid?`openReader('${n.file}')`:`buyNote('${n.id}',${n.price})`}">${isPaid?'पढ़ें':'₹'+n.price}</button></div></div>`;
            });
            document.getElementById('notesGrid').innerHTML = html;
        }

        function loadTestSeries() {
            onValue(ref(db, 'testSeries'), async snap => {
                const data = snap.val(); if(!data) return;
                const pSnap = await get(ref(db, `users/${auth.currentUser.uid}/purchases/tests`));
                const purchased = pSnap.exists() ? pSnap.val() : {};
                const grid = document.getElementById('testSeriesGrid'); grid.innerHTML = "";
                Object.keys(data).forEach(id => {
                    const s = data[id]; const isPaid = purchased[id]?.paid;
                    grid.innerHTML += `<div class="col-6 col-md-4"><div class="glass-card text-center p-2"><img src="${s.image}" class="test-card-img"><h6 class="small fw-bold">${s.title}</h6><button onclick="handleTestAction('${id}',${s.price},'${s.title}')" class="btn-premium w-100 mt-2">${isPaid?'OPEN':'₹'+s.price}</button></div></div>`;
                });
            });
        }

        window.handleTestAction = async (id, price, title) => {
            const snap = await get(ref(db, `users/${auth.currentUser.uid}/purchases/tests/${id}`));
            if(snap.exists() && snap.val().paid) openTestList(id, title); else buyTest(id, price);
        };

        window.openTestList = async (id, title) => {
            activeSeriesId = id; document.getElementById('testListOverlay').style.display = 'flex';
            document.getElementById('current-series-title').innerText = title;
            const sSnap = await get(ref(db, `testSeries/${id}`));
            const tests = JSON.parse(sSnap.val().questions || "[]");
            const rSnap = await get(ref(db, `users/${auth.currentUser.uid}/testResults/${id}`));
            const results = rSnap.exists() ? rSnap.val() : {};
            lastFetchedTotalScore = Object.values(results).reduce((a, b) => a + (typeof b === 'number' ? b : 0), 0);
            if(!globalScoreHidden) document.getElementById('global-score-text').innerText = lastFetchedTotalScore.toFixed(2);
            const box = document.getElementById('test-list-container'); box.innerHTML = "";
            tests.forEach((t, i) => {
                const completed = results[i] !== undefined; const locked = i > 0 && results[i-1] === undefined;
                box.innerHTML += `<div class="glass-card d-flex justify-content-between align-items-center ${locked?'opacity-50':''}">
                    <div><b>Mock Test ${i+1}</b><br><small>${t.length} Qns ${completed?'| Score: '+results[i].toFixed(1):''}</small></div>
                    <button class="btn btn-primary btn-sm rounded-pill px-3" onclick="${locked?'':`startExamNow('${id}',${i})`}" ${locked?'disabled':''}>${completed?'RETEST':(locked?'Locked':'START')}</button>
                </div>`;
            });
        };

        window.startExamNow = async (id, idx) => {
            activeSeriesId = id; activeTestIdx = idx;
            const snap = await get(ref(db, `testSeries/${id}`)); const s = snap.val();
            curPos = parseFloat(s.posMarks) || 1; curRatio = parseFloat(s.negRatio) || 3;
            currentExamQs = JSON.parse(s.questions)[idx]; userAnswers = new Array(currentExamQs.length).fill(null);
            qIdx = 0; document.getElementById('testListOverlay').style.display = 'none';
            document.getElementById('exam-overlay').style.display = 'flex';
            document.querySelector('.nav-dock').style.display = 'none';
            renderQuestion(); startTimer(3600);
        };

        function renderQuestion() {
            const q = currentExamQs[qIdx]; document.getElementById('q-num').innerText = `Q.${qIdx+1}/${currentExamQs.length}`;
            document.getElementById('q-text').innerText = q.q; const box = document.getElementById('opt-box'); box.innerHTML = "";
            q.options.forEach(o => box.innerHTML += `<button onclick="selectOpt('${o}')" class="opt-btn ${userAnswers[qIdx]===o?'selected':''}">${o}</button>`);
        }

        window.selectOpt = (o) => { userAnswers[qIdx] = o; renderQuestion(); setTimeout(() => { if(qIdx < currentExamQs.length-1){ qIdx++; renderQuestion(); } }, 300); };
        window.nextQ = () => { if(qIdx < currentExamQs.length-1) { qIdx++; renderQuestion(); } };
        window.prevQ = () => { if(qIdx > 0) { qIdx--; renderQuestion(); } };

        function startTimer(s) { clearInterval(examTimer); examTimer = setInterval(() => { s--; let m=Math.floor(s/60), sec=s%60; document.getElementById('exam-timer').innerText=`${m}:${sec<10?'0':''}${sec}`; if(s<=0) finishExam(); }, 1000); }

        window.finishExam = async () => {
            clearInterval(examTimer); document.getElementById('exam-overlay').style.display = 'none';
            let correct = 0, wrong = 0;
            currentExamQs.forEach((q, i) => { if(userAnswers[i] === (q.ans || q.answer)) correct++; else if(userAnswers[i] !== null) wrong++; });
            let deduction = (wrong * (curPos / curRatio)); let total = (correct * curPos) - deduction;
            const testKey = `${activeSeriesId}_${activeTestIdx}`;
            await set(ref(db, `users/${userData.uid}/testResults/${activeSeriesId}/${activeTestIdx}`), total);
            await set(ref(db, `leaderboards/${testKey}/${userData.uid}`), { score: total, userName: userData.displayName, photo: userData.photoURL });
            document.getElementById('final-score-val').innerText = total.toFixed(2);
            document.getElementById('stats-summary').innerText = `Correct: ${correct} | Wrong: ${wrong}`;
            document.getElementById('result-overlay').style.display = 'block';
            loadLeaderboard(testKey);
        };

        function loadLeaderboard(key) {
            const list = document.getElementById('leaderboard-list'); list.innerHTML = "Loading...";
            const qRef = query(ref(db, `leaderboards/${key}`), orderByChild('score'), limitToLast(15));
            onValue(qRef, snap => {
                list.innerHTML = ""; let students = [];
                snap.forEach(c => students.push(c.val()));
                students.reverse().forEach((s, i) => {
                    list.innerHTML += `<div class="leaderboard-item"><span><div class="rank-badge">${i+1}</div> ${s.userName}</span><span class="fw-bold text-primary">${s.score.toFixed(1)}</span></div>`;
                });
            });
        }

        window.closeReview = () => { document.getElementById('result-overlay').style.display = 'none'; document.querySelector('.nav-dock').style.display = 'flex'; showPage('homePage', document.querySelector('.nav-link-3d')); };
        window.closeTestList = () => document.getElementById('testListOverlay').style.display = 'none';
        window.toggleGlobalScore = () => { globalScoreHidden = !globalScoreHidden; document.getElementById('global-score-text').innerText = globalScoreHidden ? "****" : lastFetchedTotalScore.toFixed(2); document.getElementById('score-toggle-icon').className = globalScoreHidden ? "fa fa-eye-slash" : "fa fa-eye"; };
        
        window.openReader = (file) => {
            let pdfUrl = window.location.href.split('index.html')[0] + encodeURIComponent(file);
            document.getElementById('reader-overlay').style.display = 'block';
            document.getElementById('pdfViewer').src = "https://docs.google.com/viewer?url=" + encodeURIComponent(pdfUrl) + "&embedded=true";
            document.getElementById('btn-download').onclick = () => window.open(pdfUrl, '_blank');
        };
        window.closeReader = () => document.getElementById('reader-overlay').style.display = 'none';

        window.buyNote = (id, p) => { new Razorpay({key:"rzp_test_RwizK12wU5cyN6", amount:p*100, name:"Manoj Nehra", handler: async()=> { await set(ref(db,`users/${auth.currentUser.uid}/purchases/notes/${id}`),{paid:true}); loadNotes(); }}).open(); };
        window.buyTest = (id, p) => { new Razorpay({key:"rzp_test_RwizK12wU5cyN6", amount:p*100, name:"Manoj Nehra", handler: async()=> { await set(ref(db,`users/${auth.currentUser.uid}/purchases/tests/${id}`),{paid:true}); loadTestSeries(); }}).open(); };
    </script>
</body>
</html>
