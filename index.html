<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Manoj Nehra | Official Hub</title>
    
    <!-- CSS Assets -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        :root { 
            --primary: #6366f1; 
            --bg-gradient: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #312e81 100%);
        }
        body { background: var(--bg-gradient); color: #f8fafc; font-family: 'Poppins', sans-serif; min-height: 100vh; }
        .glass-card { background: rgba(255, 255, 255, 0.08); backdrop-filter: blur(25px); border: 1px solid rgba(255,255,255,0.15); border-radius: 30px; padding: 25px; }
        #auth-screen { position: fixed; inset: 0; background: #020617; z-index: 9000; display: flex; align-items: center; justify-content: center; }
        .login-box { text-align: center; width: 90%; max-width: 400px; }
        .login-logo { width: 110px; height: 110px; border-radius: 50%; border: 4px solid var(--primary); margin-bottom: 25px; }
        
        /* Main App & Profile Styles */
        #main-app { display: none; }
        .page { display: none; } .page.active { display: block; }
        .nav-dock { position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%); width: 95%; max-width: 500px; background: rgba(15, 23, 42, 0.98); border-radius: 35px; display: flex; justify-content: space-around; padding: 12px 5px; z-index: 8000; border: 1px solid rgba(255,255,255,0.1); }
        .nav-link-3d { color: rgba(255,255,255,0.4); flex: 1; text-align: center; font-size: 0.75rem; cursor: pointer; }
        .nav-link-3d.active { color: var(--primary); transform: translateY(-5px); }
        .nav-link-3d i { font-size: 1.3rem; display: block; margin-bottom: 3px; }
        
        .profile-inner { background: rgba(255, 255, 255, 0.03); border-radius: 40px; padding: 30px 20px; margin-top: 20px; text-align: center; }
        .input-group-3d { background: rgba(0,0,0,0.3); border-radius: 15px; padding: 10px; margin-bottom: 12px; border: 1px solid rgba(255,255,255,0.05); }
        .input-group-3d input { background: transparent; border: none; color: white; width: 100%; text-align: center; outline: none; }
    </style>
</head>
<body>

    <!-- LOGIN SCREEN -->
    <div id="auth-screen">
        <div class="login-box glass-card">
            <img src="./manoj.jpg.jpg" class="login-logo" onerror="this.src='https://via.placeholder.com/110'">
            <h2 class="fw-bold">MANOJ NEHRA</h2>
            <p class="small opacity-75 mb-4">Official Preparation Platform</p>
            
            <!-- Button ID added for direct JS attachment -->
            <button id="google-login-btn" class="btn btn-light w-100 rounded-pill py-3 fw-bold shadow-lg mb-3">
                <i class="fab fa-google me-2 text-danger"></i> Sign in with Google
            </button>
            
            <p class="small opacity-50">By continuing, you accept our Privacy Policy</p>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="main-app">
        <header class="container pt-4">
            <div class="d-flex align-items-center gap-3">
                <img id="header-img" src="" style="width:50px; height:50px; border-radius: 50%; border: 2px solid var(--primary);">
                <div>
                    <h6 class="fw-bold mb-0">MANOJ NEHRA</h6>
                    <div id="welcome-user" class="small text-info fw-bold">Welcome</div>
                </div>
            </div>
        </header>

        <div class="container mt-3 pb-5">
            <div id="homePage" class="page active">
                <div class="alert alert-info small">Select an option from the bottom menu.</div>
                <h3 class="fw-bold text-center mt-5">Welcome to Dashboard</h3>
            </div>
            
            <div id="profilePage" class="page">
                <div class="profile-inner">
                    <img id="u-img" src="" class="rounded-circle mb-3" style="width: 100px; height:100px; border: 3px solid var(--primary);">
                    <div class="input-group-3d"><input id="prof-name" type="text" placeholder="Name"></div>
                    <div class="input-group-3d"><input id="prof-phone" type="number" placeholder="Phone"></div>
                    <div class="input-group-3d"><input id="prof-state" type="text" placeholder="State"></div>
                    <button id="save-profile-btn" class="btn btn-primary w-100 rounded-pill mb-3">Save Profile</button>
                    <button id="logout-btn" class="btn btn-danger w-100 rounded-pill">Logout</button>
                </div>
            </div>
        </div>

        <nav class="nav-dock">
            <div class="nav-link-3d active" onclick="switchPage('homePage', this)"><i class="fas fa-home"></i>Home</div>
            <div class="nav-link-3d" onclick="switchPage('profilePage', this)"><i class="fas fa-user"></i>Profile</div>
        </nav>
    </div>

    <!-- FIREBASE SCRIPT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        // 1. CONFIGURATION
        const firebaseConfig = { 
            apiKey: "AIzaSyAhg7hKJ123JRAfio7fymK543XpuNonMHo", 
            authDomain: "showpdf-ffa34.firebaseapp.com", 
            databaseURL: "https://showpdf-ffa34-default-rtdb.firebaseio.com", 
            projectId: "showpdf-ffa34" 
        };

        // 2. INITIALIZATION
        let app, auth, db, provider;
        
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getDatabase(app);
            provider = new GoogleAuthProvider();
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.error("Firebase Init Error:", error);
            Swal.fire("System Error", "Firebase initialization failed. Check console.", "error");
        }

        // 3. LOGIN FUNCTION
        const handleLogin = async () => {
            console.log("Login button clicked..."); // Debug log
            
            if (!auth) {
                Swal.fire("Error", "Firebase not ready. Please refresh.", "error");
                return;
            }

            try {
                // Direct Popup
                const result = await signInWithPopup(auth, provider);
                Swal.fire({
                    icon: 'success',
                    title: 'Login Success',
                    timer: 1500,
                    showConfirmButton: false
                });
            } catch (error) {
                console.error("Login Error Full:", error);
                
                if (error.code === 'auth/unauthorized-domain') {
                    Swal.fire({
                        icon: 'error',
                        title: 'Domain Error',
                        text: `Add "${window.location.hostname}" to Firebase Console > Auth > Settings > Authorized Domains`
                    });
                } else if (error.code === 'auth/popup-closed-by-user') {
                    // Do nothing or show small toast
                } else {
                    Swal.fire("Login Failed", error.message, "error");
                }
            }
        };

        // 4. ATTACH EVENT LISTENERS (Robust Method)
        document.addEventListener('DOMContentLoaded', () => {
            const loginBtn = document.getElementById('google-login-btn');
            if(loginBtn) loginBtn.addEventListener('click', handleLogin);

            const logoutBtn = document.getElementById('logout-btn');
            if(logoutBtn) logoutBtn.addEventListener('click', () => signOut(auth).then(()=>location.reload()));

            const saveBtn = document.getElementById('save-profile-btn');
            if(saveBtn) saveBtn.addEventListener('click', updateProfileData);
        });

        // 5. AUTH STATE OBSERVER
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log("User found:", user.email);
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';
                
                // Set UI
                const dName = user.displayName || "User";
                const dPhoto = user.photoURL || "https://via.placeholder.com/100";
                
                document.getElementById('welcome-user').innerText = "Welcome, " + dName;
                document.getElementById('header-img').src = dPhoto;
                document.getElementById('u-img').src = dPhoto;
                document.getElementById('prof-name').value = dName;

                // Fetch Profile from DB
                try {
                    const snap = await get(ref(db, `users/${user.uid}/profile`));
                    if(snap.exists()) {
                        const data = snap.val();
                        if(data.phone) document.getElementById('prof-phone').value = data.phone;
                        if(data.state) document.getElementById('prof-state').value = data.state;
                    }
                } catch(e) { console.error("Profile fetch error", e); }

            } else {
                console.log("No user signed in");
                document.getElementById('auth-screen').style.display = 'flex';
                document.getElementById('main-app').style.display = 'none';
            }
        });

        // 6. HELPER FUNCTIONS
        async function updateProfileData() {
            const user = auth.currentUser;
            if(!user) return;
            
            const data = {
                name: document.getElementById('prof-name').value,
                phone: document.getElementById('prof-phone').value,
                state: document.getElementById('prof-state').value
            };

            await update(ref(db, `users/${user.uid}/profile`), data);
            Swal.fire("Saved", "Profile updated successfully", "success");
        }

        // Expose Page Switcher to Window (Global)
        window.switchPage = (pageId, btn) => {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            document.querySelectorAll('.nav-link-3d').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
        };
    </script>
</body>
</html>
